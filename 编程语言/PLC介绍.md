PLC知识介绍
======

PLC是指可编程逻辑控制器。

其包含I-->Input, O-->Output, M-->中间变量。 DB-->数据块。 内部具有如下区域：
I区，Q区，M区，DB区。

## PLC设备结构
PLC设备以模块方式组合在一起。一般情况下具有4个模块
- DI 数字输入
- DO 数字输出
- AI 模拟输入
- AO 模拟输出

此外还包括CPU部分，网络模块，存储部分（用来保存代码的地方）等。

其中DI主要用于控制接收数字量（例如电机的开关和点击转速）。这些数字量不是来自电机，而是来自变频器，然后变频器再控制电机。也就是说变频器并不知道电机的转速，而是变频器保存着设定的转速值，变频器就让电机以这个速度运行，所以变频器和电机是一致的。
DI部分有32bit的输入大小，相当于4byte。

DO部分是数字输出，也就是PLC的程序执行后，输出结果通过DO发送给变频器和外部设备。其主要是boolean值，所以用来控制电机开关。DO大约有30个点的输出量。当连接的外部设备控制量为2时，那么最多可以接15个设备；如果控制量为3时，只能接10个设备。所以控制量的多少决定了外接设备的数量（控制量可以不同）。我们环境上的控制量包括：开，关，远程（网络控制）等等，实际上内容可自定义。

AI部分是模拟输入，我们暂时没有使用此模块。

AO是模拟输出，模拟输出的结果发送给变频器，用来控制电机的转速。与DO不同，AO采用通道的概念，一共有8个通道，每个通道大约12bit。


## 拓扑结构
整个连接的方式为: 
- 上位机（PLC编程机）---(网线)-----> 工业网络交换机----(网线)-----> PLC网络模块。
- 变频器---(电线)----> PLC DI模块 ---> PLC DO模块 ---(电线)----> 变频器
- PLC AO模块 ---(电线)----> 电磁开关 ---(电线)---> 变频器 ----(电线)----> 电机

PLC设备可以通过DP接口连接另外一台PLC设备。形成一个PLC控制另外一台PLC设备。两台PLC都有对应的程序，执行不同的任务。

## PLC编程语言和环境
PLC编程有很多种语言：梯形图, STL, SFC, FBC。而且每种厂家还有可能不一样。下面主要介绍的是梯形图和STL语言。

### 梯形图
梯形图采用图形的方式进行编程。例如：
```

|   I0.0     I0.1      Q0.0
|----||-------|/|-------O
|         |
|----||---|
|    Q0.0
```
上面的梯形图就是用来控制电机的启停功能。

### STL语言
STL语言有些类似于汇编语言。首先定义输入量和输出量，然后再编程界面进行输入语句。
```
// 读取设定值
L #Input_real
L #H_lim
>=R
// 如果设定值大于最大值，则使用最大值
JXB E1
L #Input_real
L #H_low
<=R
JXB E2

E1: Input_real = H_lim

...

T #Ouput_int

```
中间有些忘记了，代码的功能是改变电机的转速。其中L代表Load。L #Input_real代码加载设定值。R代表实数， >=R代表实数对比。JXB代表跳转。

逻辑过程：首先加载设定值，如果大于最大值则设定值为最大值，如果小于最小值，则设定值改成最小值。然后把计算最大值和最小值的差，把差值映射到0~27648（这个最大值映射到0~10电压上，或者4~20mA, 或0~20mA）。最后把映射的结果返回。

上面代码实际上是一个程序块，存储在某个块中，一共有几十个块（块数量估计与设备型号有关系）。程序块之间还有优先级，优先级高的先运行。例如上面代码保存在OB1中，那么就会在OB35中的代码运行之后才运行。

程序块的代码输入和输出在使用的时候，要选定对应的内存地址，内存地址的选择需要使用WinCC软件连接到PLC上后，通过**变量管理器**查看例如DO模块的地址范围。例如: 304~307。然后设定输出为`PQW304`。（P代表立即， Q代表输出，W代表范围）。可以在编程环境中通过QW304来监控PLC上此内存地址的值变化。

编程环境
- SIMATIC Manager: 纯代码编辑工具 （软件很大，6个多G）
- WinCC： 西门子提供的用来编写图形界面的工具
- 组态王： 国内提供的用于编程和界面开发的工具。

### 界面开发
界面实在HMI，或者上位机进行开发的。代码首先通过开发工具的**下载**功能把PLC代码保存到PLC设备存储卡上。然后再图形开发界面上，类似VB拖动控件的方式进行图形绘制，然后图形内部使用**属性**菜单中的动作设置调用编写好的程序块。调用方式可以使用C语言，例如`setTagBit("A1", 1)`用来调用程序块设定好的A1地址，给定值为1，意思是开启电机。图形的颜色控制也是通过此类代码来设定A1, A2, A3等内存地址的值(A1是图形界面中的变量名称，具体的值为M2.0, M2.1等等, M对应PLC中间变量内存地址)。

### 开发流程
1. 在SIMATIC Manager上使用梯形图或者STL语言写好代码，放到一个程序块中，然后下载代码到PLC设备内。
2. 使用WinCC开发界面图形程序，调用程序块中操作的对应内存地址。根据内存地址的变化来显示对应的颜色信息。或者让按钮控制PLC内存地址的值。
3. 在WinCC中启动运行图形界面，就可以控制设备了。


## OPC协议
OPC协议是一个开放标准协议。大家都一起支持的话，就可以实现控制不同的PLC设备。

西门子PLC200就只支持OPC协议（西门子收购的厂家，之前不支持S7协议）。导致西门子的开发工具不能控制这个设备（工具不支持OPC协议）。这是可使用美国开发的一个工具Kepware（其支持各种协议），然后让Keypare连接PLC设备，然后WinCC写好程序再连接Kepware。这样就能间接控制支持OPC协议的PLC设备。

@完





